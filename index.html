<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <title>Unendliches Jump & Run mit Online-Highscore</title>
  <style>
    body { font-family: system-ui, sans-serif; margin:0; background:#87CEEB; display:flex; flex-direction:column; align-items:center; }
    #game { background:linear-gradient(#87CEEB,#6FC3F0); border-radius:12px; margin-top:20px; }
    .hud { margin-top:10px; display:flex; gap:10px; }
    .panel { background:#fff9; padding:6px 10px; border-radius:6px; font-weight:bold; }
    #authSection { margin-top:20px; padding:10px; background:#fff9; border-radius:10px; }
    #authSection input { display:block; margin:5px 0; padding:6px; width: 95%; }
    #authMessage { margin-top:8px; font-weight:bold; }
    #leaderboard { margin-top:20px; background:#fff9; padding:10px; border-radius:10px; min-width:200px; }
    button { padding:6px 10px; margin-top:5px; width: 100%; font-weight:bold; border-radius:6px; cursor:pointer; }
  </style>
</head>
<body>
  <h1>Unendliches Jump & Run</h1>

  <div id="authSection">
    <h3>Login / Registrierung</h3>
    <input id="email" placeholder="E-Mail">
    <input id="password" type="password" placeholder="Passwort">
    <input id="username" placeholder="Benutzername (nur bei Registrierung)">
    <button id="registerBtn">Registrieren</button>
    <button id="loginBtn">Login</button>
    <div id="authMessage"></div>
  </div>

  <canvas id="game" width="800" height="400"></canvas>
  <div class="hud">
    <div class="panel">Score: <span id="score">0</span></div>
    <div class="panel">Highscore: <span id="highscore">0</span></div>
  </div>

  <div id="leaderboard"><i>Leaderboard lädt…</i></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-analytics.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword } 
      from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
    import { getDatabase, ref, set, update, get } 
      from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA_IPMf3X1PABrfMlrpgT0tMCTeQVnhLUs",
      authDomain: "jumpandrunhighscore.firebaseapp.com",
      databaseURL: "https://jumpandrunhighscore-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "jumpandrunhighscore",
      storageBucket: "jumpandrunhighscore.firebasestorage.app",
      messagingSenderId: "770421489723",
      appId: "1:770421489723:web:8bc433474dae3d7d5edc1e",
      measurementId: "G-SJD78YNJK0"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const auth = getAuth(app);
    const db = getDatabase(app);

    let currentUser = null;
    let currentUsername = null;
    let gameLoopId = null;

    const msg = document.getElementById("authMessage");
    const scoreEl = document.getElementById("score");
    const highscoreEl = document.getElementById("highscore");

    // === Registrierung ===
    async function registerUser() {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      const username = document.getElementById("username").value;
      if(!username){ msg.style.color="red"; msg.textContent="Bitte Benutzernamen eingeben"; return; }
      try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const uid = userCredential.user.uid;
        await set(ref(db, "users/" + uid), { username, highscore: 0 });
        currentUser = uid;
        currentUsername = username;
        msg.style.color = "green";
        msg.textContent = "Account erstellt & eingeloggt als " + username;
        startGame(0);
        updateLeaderboard();
      } catch (err) {
        msg.style.color = "red";
        msg.textContent = err.message;
      }
    }

    // === Login ===
    async function loginUser() {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      try {
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        const uid = userCredential.user.uid;
        const snap = await get(ref(db, "users/" + uid));
        if (snap.exists()) {
          const data = snap.val();
          currentUser = uid;
          currentUsername = data.username;
          msg.style.color = "green";
          msg.textContent = "Willkommen zurück, " + data.username;
          startGame(data.highscore ?? 0);
          updateLeaderboard();
        }
      } catch (err) {
        msg.style.color = "red";
        msg.textContent = err.message;
      }
    }

    // === Buttons für iPad/Desktop ===
    document.addEventListener("DOMContentLoaded", () => {
      const registerBtn = document.getElementById("registerBtn");
      const loginBtn = document.getElementById("loginBtn");

      registerBtn.addEventListener("click", registerUser);
      registerBtn.addEventListener("touchend", registerUser);

      loginBtn.addEventListener("click", loginUser);
      loginBtn.addEventListener("touchend", loginUser);
    });

    // === Leaderboard ===
    async function updateLeaderboard(){
      const leaderboardEl = document.getElementById("leaderboard");
      leaderboardEl.innerHTML = "⏳ Lade...";
      try {
        const snap = await get(ref(db,"users/"));
        if(!snap.exists()){ leaderboardEl.innerHTML = "Keine Einträge."; return; }
        const arr = [];
        snap.forEach(c => arr.push(c.val()));
        arr.sort((a,b)=> (b.highscore||0) - (a.highscore||0));
        const top = arr.slice(0,10);
        leaderboardEl.innerHTML = top.map(u =>
          (u.username === currentUsername ? `<b>${u.username}: ${u.highscore || 0}</b>` : `${u.username}: ${u.highscore || 0}`)
        ).join("<br>");
      } catch(e){
        console.error("Fehler Leaderboard:", e);
        leaderboardEl.innerHTML = "⚠️ Fehler beim Laden";
      }
    }
    setInterval(updateLeaderboard, 5000);

    // === Spiel ===
    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");
    let player, ground, obstacles, speed, score, highscore, gameOver;

    function startGame(savedHS){
      if(gameLoopId) cancelAnimationFrame(gameLoopId);
      player = {x:100,y:0,w:40,h:50,vy:0,jumpPower:-12,grounded:false};
      ground = {y:canvas.height-60,height:60};
      obstacles = [];
      speed = 5;
      score = 0;
      highscore = savedHS||0;
      highscoreEl.textContent = highscore;
      gameOver=false;
      player.y = ground.y - player.h;
      gameLoopId = requestAnimationFrame(loop);
    }

    function spawnObstacle(){
      const h = 20+Math.random()*40;
      const w = 20+Math.random()*30;
      const y = ground.y-h;
      obstacles.push({x:canvas.width+20,y,w,h});
    }

    function collides(a,b){
      return a.x < b.x+b.w && a.x+a.w > b.x && a.y < b.y+b.h && a.y+a.h > b.y;
    }

    function update(){
      if(gameOver) return;
      player.vy += 0.6;
      player.y += player.vy;
      if(player.y+player.h >= ground.y){ player.y=ground.y-player.h; player.vy=0; player.grounded=true; }
      if(Math.random()<0.02) spawnObstacle();
      obstacles.forEach(o=> o.x -= speed);
      for(const o of obstacles){
        if(collides(player,o)){ 
          gameOver=true; 
          saveHighscore(); 
        }
      }
      score+=0.1;
      scoreEl.textContent = Math.floor(score);
    }

    function draw(){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle="#4CAF50"; ctx.fillRect(0,ground.y,canvas.width,ground.height);
      ctx.fillStyle="red"; ctx.fillRect(player.x,player.y,player.w,player.h);
      ctx.fillStyle="black";
      obstacles.forEach(o=> ctx.fillRect(o.x,o.y,o.w,o.h));
      if(gameOver){ 
        ctx.fillStyle="rgba(0,0,0,0.5)"; 
        ctx.fillRect(0,0,canvas.width,canvas.height);
        ctx.fillStyle="white"; 
        ctx.font="30px sans-serif"; 
        ctx.fillText("Game Over", canvas.width/2-80, canvas.height/2);
      }
    }

    function loop(){
      update();
      draw();
      if(!gameOver) gameLoopId = requestAnimationFrame(loop);
    }

    window.addEventListener("keydown", e=>{
      if(e.code==="Space" && player.grounded){ player.vy=player.jumpPower; player.grounded=false; }
    });

    function saveHighscore(){
      const s = Math.floor(score);
      if(s > highscore){
        highscore=s;
        highscoreEl.textContent=highscore;
        if(currentUser){
          update(ref(db,"users/"+currentUser), {highscore:highscore});
          updateLeaderboard();
        }
      }
    }
  </script>
</body>
</html>






