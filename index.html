<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Unendliches Jump & Run</title>
  <!-- dein vorhandenes CSS -->
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div id="authSection">
    <h2>Login / Registrierung</h2>
    <input id="email" placeholder="E-Mail"><br>
    <input id="password" type="password" placeholder="Passwort"><br>
    <input id="username" placeholder="Benutzername (nur bei Registrierung)"><br>
    <button id="registerBtn">Registrieren</button>
    <button id="loginBtn">Login</button>
    <div id="authMessage" style="color:red; font-weight:bold; margin-top:10px;"></div>
  </div>

  <div id="gameWrap" style="display:none;">
    <canvas id="game" width="900" height="420"></canvas>
    <div class="hud">
      <div class="panel">Score: <span id="score">0</span></div>
      <div class="panel">Highscore: <span id="highscore">0</span></div>
      <div class="panel" id="leaderboard">Highscores werden geladen...</div>
      <div class="controls">Tasten: Leertaste / Klick / Tippen zum Springen</div>
      <button id="pauseBtn">Pause</button>
      <button id="resetBtn">Neustart</button>
    </div>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import {
  getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword,
  onAuthStateChanged, setPersistence, browserLocalPersistence
} from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
import {
  getDatabase, ref, set, get, onValue, runTransaction
} from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";

// --- Firebase-Konfiguration ---
const firebaseConfig = {
  apiKey: "AIzaSyA_IPMf3X1PABrfMlrpgT0tMCTeQVnhLUs",
  authDomain: "jumpandrunhighscore.firebaseapp.com",
  databaseURL: "https://jumpandrunhighscore-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "jumpandrunhighscore",
  storageBucket: "jumpandrunhighscore.firebasestorage.app",
  messagingSenderId: "770421489723",
  appId: "1:770421489723:web:8bc433474dae3d7d5edc1e",
  measurementId: "G-SJD78YNJK0"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

let currentUser = null;
let currentUsername = "";

// UI
const msg = document.getElementById("authMessage");
const gameWrap = document.getElementById("gameWrap");
const authSection = document.getElementById("authSection");

// --- Leaderboard ---
function setupLeaderboardRealtime() {
  const usersRef = ref(db, "users");
  onValue(usersRef, snapshot => {
    if (!snapshot.exists()) {
      document.getElementById("leaderboard").innerText = "Keine Highscores vorhanden";
      return;
    }
    const data = snapshot.val();
    const arr = Object.values(data).map(u => ({ username: u.username, highscore: u.highscore || 0 }));
    arr.sort((a, b) => b.highscore - a.highscore);
    const top10 = arr.slice(0, 10);
    document.getElementById("leaderboard").innerHTML = top10.map(u =>
      u.username === currentUsername ? `<b>${u.username}: ${u.highscore}</b>` : `${u.username}: ${u.highscore}`
    ).join("<br>");
  });
}

// --- Registrierung ---
async function registerUser() {
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value;
  const username = document.getElementById("username").value.trim();
  if (!username) return msg.textContent = "Bitte Benutzername eingeben";
  if (!email || !password) return msg.textContent = "E-Mail & Passwort erforderlich";

  try {
    await setPersistence(auth, browserLocalPersistence);
    const userCred = await createUserWithEmailAndPassword(auth, email, password);
    await set(ref(db, "users/" + userCred.user.uid), { username, highscore: 0 });
    msg.style.color = "green";
    msg.textContent = "Registriert – Login erfolgt automatisch.";
  } catch (err) {
    msg.style.color = "red";
    msg.textContent = err.message;
  }
}

// --- Login ---
async function loginUser() {
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value;
  if (!email || !password) return msg.textContent = "E-Mail & Passwort erforderlich";
  try {
    await setPersistence(auth, browserLocalPersistence);
    await signInWithEmailAndPassword(auth, email, password);
    msg.style.color = "green";
    msg.textContent = "Login erfolgreich – lade Profil...";
  } catch (err) {
    msg.style.color = "red";
    msg.textContent = err.message;
  }
}

document.getElementById("registerBtn").addEventListener("click", registerUser);
document.getElementById("loginBtn").addEventListener("click", loginUser);

// --- Wenn Benutzer eingeloggt ist ---
onAuthStateChanged(auth, async (user) => {
  if (!user) return;
  currentUser = user.uid;
  try {
    const snap = await get(ref(db, "users/" + currentUser));
    let dbHighscore = 0;
    if (snap.exists()) {
      const data = snap.val();
      currentUsername = data.username;
      dbHighscore = data.highscore || 0;
    } else {
      await set(ref(db, "users/" + currentUser), { username: "Spieler", highscore: 0 });
    }
    setupLeaderboardRealtime();
    msg.style.color = "green";
    msg.textContent = "Willkommen zurück, " + currentUsername;
    startGame(dbHighscore);
  } catch (err) {
    console.error("Profil-Laden fehlgeschlagen:", err);
    startGame(0);
  }
});

// --- Spiel ---
let globalGameRunning = false;
async function startGame(existingHighscore = 0) {
  if (globalGameRunning) return;
  globalGameRunning = true;

  authSection.style.display = "none";
  gameWrap.style.display = "flex";

  const canvas = document.getElementById("game");
  const ctx = canvas.getContext("2d");
  const W = canvas.width, H = canvas.height;
  const scoreEl = document.getElementById("score");
  const highscoreEl = document.getElementById("highscore");

  let highscore = existingHighscore;
  let score = 0;
  let gameOver = false, paused = false, wantJump = false;

  // --- Hol echten Highscore nochmal aus Firebase ---
  try {
    if (currentUser) {
      const s = await get(ref(db, "users/" + currentUser + "/highscore"));
      if (s.exists()) highscore = s.val() || highscore;
    }
  } catch { }
  highscoreEl.textContent = highscore;

  // --- Highscore speichern (nur wenn größer) ---
  async function writeHighscoreIfHigher(newScore) {
    if (!currentUser) return;
    try {
      await runTransaction(ref(db, "users/" + currentUser + "/highscore"), old => {
        if (old === null || newScore > old) return newScore;
        return old;
      });
    } catch (err) {
      console.warn("Highscore-Update fehlgeschlagen:", err);
    }
  }

  function saveHighscoreLocal() {
    const s = Math.floor(score);
    if (s > highscore) {
      highscore = s;
      highscoreEl.textContent = highscore;
      writeHighscoreIfHigher(s);
    }
  }

  // --- Game logic ---
  const ground = { y: H - 80, height: 80 };
  const player = { x: 120, y: ground.y - 60, w: 44, h: 60, vy: 0, grounded: true, color: "#ff6b6b" };
  let obstacles = [], frame = 0, speed = 5;

  function spawnObstacle() {
    const h = Math.random() * 30 + 30;
    obstacles.push({ x: W + 50, y: ground.y - h, w: 30, h, color: "#333" });
  }

  function update() {
    if (paused || gameOver) return;
    frame++;
    if (frame % 200 === 0) spawnObstacle();
    if (wantJump && player.grounded) { player.vy = -13; player.grounded = false; }
    player.vy += 0.7; player.y += player.vy;
    if (player.y + player.h >= ground.y) { player.y = ground.y - player.h; player.vy = 0; player.grounded = true; }
    obstacles.forEach(o => o.x -= speed);
    obstacles = obstacles.filter(o => o.x + o.w > 0);
    for (const o of obstacles) {
      if (player.x < o.x + o.w && player.x + player.w > o.x && player.y + player.h > o.y) {
        gameOver = true; saveHighscoreLocal();
      }
    }
    score += 0.1;
    scoreEl.textContent = Math.floor(score);
    saveHighscoreLocal();
  }

  function draw() {
    ctx.clearRect(0, 0, W, H);
    ctx.fillStyle = "#87CEEB"; ctx.fillRect(0, 0, W, H);
    ctx.fillStyle = "#4CAF50"; ctx.fillRect(0, ground.y, W, ground.height);
    ctx.fillStyle = player.color;
    ctx.fillRect(player.x, player.y, player.w, player.h);
    obstacles.forEach(o => {
      ctx.fillStyle = o.color;
      ctx.fillRect(o.x, o.y, o.w, o.h);
    });
    if (gameOver) {
      ctx.fillStyle = "rgba(0,0,0,0.6)";
      ctx.fillRect(0, 0, W, H);
      ctx.fillStyle = "white";
      ctx.font = "bold 36px system-ui";
      ctx.textAlign = "center";
      ctx.fillText("Game Over", W / 2, H / 2);
    }
  }

  // --- Steuerung ---
  window.addEventListener("keydown", e => { if (e.code === "Space") wantJump = true; });
  window.addEventListener("keyup", e => { if (e.code === "Space") wantJump = false; });
  document.getElementById("pauseBtn").addEventListener("click", () => paused = !paused);
  document.getElementById("resetBtn").addEventListener("click", () => location.reload());

  function loop() { update(); draw(); requestAnimationFrame(loop); }
  loop();

  window.addEventListener("beforeunload", saveHighscoreLocal);
}
</script>
</body>
</html>
