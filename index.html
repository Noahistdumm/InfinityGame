<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Jump & Run Game</title>
  <style>
    :root{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
    html,body{height:100%;margin:0;background:#87CEEB;}
    #authSection{margin:20px auto;text-align:center}
    #authSection input{padding:6px;margin:4px;border-radius:6px;border:1px solid #ccc;width:220px}
    button{padding:8px 12px;border-radius:8px;border:0;background:#1f8ef1;color:white;font-weight:700;margin-top:6px;cursor:pointer}
    #gameWrap{display:none;flex-direction:column;height:100vh;align-items:center;justify-content:center}
    canvas{background:linear-gradient(#87CEEB,#6FC3F0);border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,0.15)}
    .hud{margin-top:12px;display:flex;gap:12px;align-items:center;flex-wrap:wrap;justify-content:center}
    .panel{background:rgba(255,255,255,0.9);padding:8px 12px;border-radius:8px;font-weight:600;max-height:200px;overflow:auto}
    .controls{font-size:13px;color:#333}
    #storyPanel{display:none;position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);color:white;align-items:center;justify-content:center;flex-direction:column;text-align:center;font-size:20px;padding:20px}
  </style>
</head>
<body>
  <!-- LOGIN -->
  <div id="authSection">
    <h2>Login / Registrierung</h2>
    <input id="email" placeholder="E-Mail"><br>
    <input id="password" type="password" placeholder="Passwort"><br>
    <input id="username" placeholder="Benutzername (nur bei Registrierung)"><br>
    <button id="registerBtn">Registrieren</button>
    <button id="loginBtn">Login</button>
    <button id="logoutBtn" style="display:none;background:#e74c3c">Abmelden</button><br>
    <div id="authMessage" style="color:red; font-weight:bold; margin-top:10px;"></div>
  </div>

  <!-- GAME -->
  <div id="gameWrap">
    <canvas id="gameCanvas" width="900" height="420"></canvas>
    <div class="hud">
      <div class="panel">Score: <span id="score">0</span></div>
      <div class="panel">Highscore: <span id="highscore">0</span></div>
      <div class="panel" id="leaderboard">Highscores werden geladen...</div>
      <div class="controls">Tasten: Leertaste / Klick / Tippen zum Springen â€¢ R zum Neustart</div>
      <button id="pauseBtn">Pause</button>
    </div>
  </div>

  <!-- STORY PANEL -->
  <div id="storyPanel">
    <div id="storyText"></div>
    <button id="nextLevelBtn">Weiter</button>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } 
    from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
  import { getDatabase, ref, set, get, update, query, orderByChild, limitToLast } 
    from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";

  // --- Firebase Config ---
  const firebaseConfig = {
    apiKey: "AIzaSyA_IPMf3X1PABrfMlrpgT0tMCTeQVnhLUs",
    authDomain: "jumpandrunhighscore.firebaseapp.com",
    databaseURL: "https://jumpandrunhighscore-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "jumpandrunhighscore",
    storageBucket: "jumpandrunhighscore.appspot.com",
    messagingSenderId: "770421489723",
    appId: "1:770421489723:web:8bc433474dae3d7d5edc1e",
    measurementId: "G-SJD78YNJK0"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  let currentUser = null;
  let currentUsername = "";

  const msg = document.getElementById("authMessage");
  const gameWrap = document.getElementById("gameWrap");
  const authSection = document.getElementById("authSection");
  const logoutBtn = document.getElementById("logoutBtn");

  // --- Auth Funktionen ---
  async function registerUser() {
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;
    const username = document.getElementById("username").value;
    if(!username){ msg.textContent="Bitte Benutzername eingeben"; return; }
    try {
      const userCredential = await createUserWithEmailAndPassword(auth, email, password);
      const uid = userCredential.user.uid;
      await set(ref(db,"users/"+uid),{ username, highscore:0 });
      msg.style.color="green"; msg.textContent="Registrierung erfolgreich!";
    } catch (err) {
      msg.style.color="red"; msg.textContent=err.message;
    }
  }

  async function loginUser() {
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;
    try {
      await signInWithEmailAndPassword(auth, email, password);
      msg.style.color="green"; msg.textContent="Login erfolgreich!";
    } catch (err) {
      msg.style.color="red"; msg.textContent=err.message;
    }
  }

  function logoutUser() {
    signOut(auth);
  }

  // --- Immer eingeloggt bleiben ---
  onAuthStateChanged(auth, async (user)=>{
    if(user){
      currentUser = user.uid;
      const snap = await get(ref(db,"users/"+currentUser));
      if(snap.exists()){
        currentUsername = snap.val().username;
        startGame(snap.val().highscore||0);
      }
      authSection.style.display="none";
      gameWrap.style.display="flex";
      logoutBtn.style.display="inline-block";
    } else {
      currentUser=null; currentUsername="";
      authSection.style.display="block";
      gameWrap.style.display="none";
      logoutBtn.style.display="none";
    }
  });

  document.getElementById("registerBtn").addEventListener("click", registerUser);
  document.getElementById("loginBtn").addEventListener("click", loginUser);
  logoutBtn.addEventListener("click", logoutUser);

  // --- GAME CODE ---
  const canvas = document.getElementById("gameCanvas");
  const ctx = canvas.getContext("2d");
  let Wc=canvas.width, Hc=canvas.height;

  let scoreEl=document.getElementById("score");
  let highscoreEl=document.getElementById("highscore");
  let leaderboardEl=document.getElementById("leaderboard");

  let storyPanel=document.getElementById("storyPanel");
  let storyText=document.getElementById("storyText");
  let nextBtn=document.getElementById("nextLevelBtn");

  let currentMode="endless";
  let level=0;
  const storyTexts=["Level 1: Die Reise beginnt...","Level 2: Der Wald wird dichter...","Level 3: Die Nacht bricht herein...","Finale: Zeige dass du ein Held bist!"];

  let player={x:120,y:0,w:44,h:60,vy:0,jumpPower:-13,grounded:false,color:'#ff6b6b'};
  let ground={y:Hc-80,h:80};
  let obstacles=[],spawnTimer=0,spawnInterval=90;
  let baseSpeed=5,speed=baseSpeed;
  let frame=0,wantJump=false,gameOver=false,score=0,highscore=0;

  function resetGame(){
    obstacles=[];spawnTimer=0;spawnInterval=90;baseSpeed=5;speed=baseSpeed;score=0;frame=0;gameOver=false;
    player.y=ground.y-player.h;player.vy=0;player.grounded=true;scoreEl.textContent=score;
  }
  function spawnObstacle(){const h=Math.round(Math.random()*30+20),w=Math.round(Math.random()*20+18),y=ground.y-h;obstacles.push({x:Wc+20,y,w,h,passed:false,color:'#2d3436'});}
  function collides(a,b){const buf=8;return a.x+buf<b.x+b.w&&a.x+a.w-buf>b.x&&a.y+buf<b.y+b.h&&a.y+a.h-buf>b.y;}
  function saveHighscore(){if(score>highscore){highscore=Math.floor(score);highscoreEl.textContent=highscore;update(ref(db,"users/"+currentUser),{highscore});}}
  async function updateLeaderboard(){const q=query(ref(db,"users/"),orderByChild("highscore"),limitToLast(10));const snap=await get(q);let arr=[];snap.forEach(c=>arr.push(c.val()));arr.sort((a,b)=>b.highscore-a.highscore);leaderboardEl.innerHTML=arr.map(u=>(u.username===currentUsername?`<b>${u.username}: ${u.highscore}</b>`:`${u.username}: ${u.highscore}`)).join("<br>");}
  setInterval(updateLeaderboard,3000);

  document.getElementById('pauseBtn').addEventListener('click',()=>{paused=!paused;document.getElementById('pauseBtn').textContent=paused?"Fortsetzen":"Pause";});
  window.addEventListener('keydown',e=>{if(e.code==="Space")wantJump=true;if(e.key==="r"&&gameOver)resetGame();});
  window.addEventListener('keyup',e=>{if(e.code==="Space")wantJump=false;});
  canvas.addEventListener('mousedown',()=>{wantJump=true;setTimeout(()=>wantJump=false,100);});
  canvas.addEventListener('touchstart',e=>{e.preventDefault();wantJump=true;setTimeout(()=>wantJump=false,150);},{passive:false});

  let paused=false;
  function update(){
    if(paused||gameOver)return;
    frame++;baseSpeed+=frame%300===0?0.3:0;speed=baseSpeed+Math.floor(frame/600)*0.4;
    if(wantJump&&player.grounded){player.vy=player.jumpPower;player.grounded=false;}
    player.vy+=0.7;player.y+=player.vy;
    if(player.y+player.h>=ground.y){player.y=ground.y-player.h;player.vy=0;player.grounded=true;}
    spawnTimer++;if(spawnTimer>=spawnInterval){spawnObstacle();spawnTimer=0;spawnInterval=Math.max(50,Math.round(60+Math.random()*80-frame*0.02));}
    for(let i=obstacles.length-1;i>=0;i--){const ob=obstacles[i];ob.x-=speed;if(!ob.passed&&ob.x+ob.w<player.x){ob.passed=true;score+=10;}if(ob.x+ob.w<-50)obstacles.splice(i,1);if(collides(player,ob)){gameOver=true;saveHighscore();if(currentMode==="story"){level++;if(level<storyTexts.length){storyText.textContent=storyTexts[level];storyPanel.style.display="flex";}}}}
    score+=0.02*speed;scoreEl.textContent=Math.floor(score);
  }
  function draw(){
    ctx.clearRect(0,0,Wc,Hc);
    ctx.fillStyle="#4CAF50";ctx.fillRect(0,ground.y,Wc,ground.h);
    for(const ob of obstacles){ctx.fillStyle=ob.color;ctx.fillRect(ob.x,ob.y,ob.w,ob.h);}
    ctx.fillStyle=player.color;ctx.fillRect(player.x,player.y,player.w,player.h);
    if(gameOver){ctx.fillStyle="rgba(0,0,0,0.6)";ctx.fillRect(0,0,Wc,Hc);ctx.fillStyle="white";ctx.font="bold 36px system-ui";ctx.textAlign="center";ctx.fillText("Game Over",Wc/2,Hc/2-10);}
  }
  function loop(){update();draw();requestAnimationFrame(loop);}
  function startGame(existingHighscore=0){highscore=existingHighscore;highscoreEl.textContent=highscore;resetGame();loop();}

  nextBtn.onclick=()=>{storyPanel.style.display="none";resetGame();};
</script>
</body>
</html>













