<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Unendliches Jump & Run</title>
<style>
:root{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
html,body{height:100%;margin:0;background:linear-gradient(to top,#6FC3F0,#87CEEB);}
#authSection,#menuSection,#gameWrap{display:flex;flex-direction:column;height:100vh;align-items:center;justify-content:center;}
canvas{background:linear-gradient(#a0d8ef,#6FC3F0);border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,0.25);}
.hud{margin-top:12px;display:flex;gap:12px;align-items:center;flex-wrap:wrap;justify-content:center;}
.panel{background:rgba(255,255,255,0.9);padding:8px 12px;border-radius:8px;font-weight:600;}
button{padding:8px 14px;border-radius:8px;border:0;background:#1f8ef1;color:white;font-weight:700;margin:4px;cursor:pointer;box-shadow:0 4px 8px rgba(0,0,0,0.15);transition:0.2s;}
button:hover{background:#0d6efd;}
#storyPanel{position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.75);color:white;display:none;flex-direction:column;align-items:center;justify-content:center;text-align:center;font-size:20px;padding:20px;z-index:999;}
#storyPanel button{background:#ff6b6b;margin-top:20px;}
</style>
</head>
<body>

<!-- Auth -->
<div id="authSection">
<h2>Login / Registrierung</h2>
<input id="email" placeholder="Email"><br>
<input id="password" type="password" placeholder="Passwort"><br>
<button id="loginBtn">Login</button>
<button id="signupBtn">Registrieren</button>
<div id="authMsg" style="margin-top:10px;font-weight:bold;color:red;"></div>
</div>

<!-- Menü -->
<div id="menuSection" style="display:none;">
<h2>Spielmodus wählen</h2>
<button id="endlessBtn">Endless Mode</button>
<button id="storyBtn">Story Mode</button>
<button id="logoutBtn" style="background:#ff6b6b;">Logout</button>
</div>

<!-- Spiel -->
<div id="gameWrap" style="display:none;position:relative;">
<canvas id="gameCanvas" width="900" height="420"></canvas>
<div class="hud">
<div class="panel">Score: <span id="score">0</span></div>
<div class="panel">Highscore: <span id="highscore">0</span></div>
</div>
<div class="panel" style="max-height:150px;overflow:auto;">
<h3>Leaderboard</h3>
<div id="leaderboard"></div>
</div>
<button id="backMenuBtn">Zurück zum Menü</button>
<div id="storyPanel">
<div id="storyText"></div>
<button id="nextLevelBtn">Weiter</button>
</div>
</div>

<!-- Firebase + Spiel -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
import { getDatabase, ref, set, get, update, query, orderByChild, limitToLast } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";

// --- Firebase Config ---
const firebaseConfig = {
apiKey: "AIzaSyA_IPMf3X1PABrfMlrpgT0tMCTeQVnhLUs",
authDomain: "jumpandrunhighscore.firebaseapp.com",
databaseURL: "https://jumpandrunhighscore-default-rtdb.europe-west1.firebasedatabase.app",
projectId: "jumpandrunhighscore",
storageBucket: "jumpandrunhighscore.appspot.com",
messagingSenderId: "770421489723",
appId: "1:770421489723:web:8bc433474dae3d7d5edc1e",
measurementId: "G-SJD78YNJK0"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

// --- Elemente ---
const authSection=document.getElementById("authSection");
const menuSection=document.getElementById("menuSection");
const gameWrap=document.getElementById("gameWrap");
const authMsg=document.getElementById("authMsg");
const scoreEl=document.getElementById("score");
const highscoreEl=document.getElementById("highscore");
const leaderboardEl=document.getElementById("leaderboard");
const storyPanel=document.getElementById("storyPanel");
const storyText=document.getElementById("storyText");
const nextBtn=document.getElementById("nextLevelBtn");

let currentUser=null, currentUsername="";
let highscore=0;

// --- Immer angemeldet bleiben ---
onAuthStateChanged(auth,user=>{
  if(user){
    currentUser=user.uid;
    get(ref(db,"users/"+user.uid)).then(snap=>{
      if(snap.exists()){
        currentUsername=snap.val().username;
        highscore=snap.val().highscore||0;
        highscoreEl.textContent=highscore;
      } else {
        currentUsername=user.email.split("@")[0];
        set(ref(db,"users/"+user.uid),{username:currentUsername, highscore:0});
      }
    });
    authSection.style.display="none";
    menuSection.style.display="flex";
  } else {
    currentUser=null;
    authSection.style.display="flex";
    menuSection.style.display="none";
    gameWrap.style.display="none";
  }
});

// --- Login / Signup ---
loginBtn.onclick=()=>signInWithEmailAndPassword(auth,email.value,password.value).catch(e=>authMsg.textContent=e.message);
signupBtn.onclick=()=>createUserWithEmailAndPassword(auth,email.value,password.value)
.then(u=>set(ref(db,"users/"+u.user.uid),{username:email.value.split("@")[0], highscore:0}))
.catch(e=>authMsg.textContent=e.message);

// --- Logout ---
logoutBtn.onclick=()=>signOut(auth);

// --- Menü Buttons ---
endlessBtn.onclick=()=>startGame("endless");
storyBtn.onclick=()=>startGame("story");
backMenuBtn.onclick=()=>{
  gameWrap.style.display="none";
  menuSection.style.display="flex";
};

// --- Spiel Logik ---
const canvas=document.getElementById("gameCanvas");
const ctx=canvas.getContext("2d");
const Wc=canvas.width,Hc=canvas.height;
let player, ground, obstacles, spawnTimer, spawnInterval, baseSpeed, speed, frame, score, gameOver, wantJump;
let currentMode="endless", level=0;
const storyTexts=["Level 1: Die Reise beginnt...","Level 2: Der Wald wird dichter...","Level 3: Die Nacht bricht herein...","Finale: Zeige dass du ein Held bist!"];

nextBtn.onclick=()=>{ storyPanel.style.display="none"; resetGame(); };

function resetGame(){
  obstacles=[]; spawnTimer=0; spawnInterval=90; baseSpeed=5; speed=baseSpeed; score=0; frame=0; gameOver=false;
  player={x:120,y:0,w:44,h:60,vy:0,jumpPower:-13,grounded:false,color:'#ff6b6b'};
  ground={y:Hc-80,h:80};
  scoreEl.textContent=Math.floor(score);
}

function spawnObstacle(){
  const h=Math.round(Math.random()*30+20);
  const w=Math.round(Math.random()*20+18);
  obstacles.push({x:Wc+20,y:ground.y-h,w,h,passed:false,color:'#2d3436'});
}

function collides(a,b){
  const buf=8;
  return a.x+buf<b.x+b.w && a.x+a.w-buf>b.x && a.y+buf<b.y+b.h && a.y+a.h-buf>b.y;
}

function saveHighscore(){
  if(score>highscore){
    highscore=Math.floor(score);
    highscoreEl.textContent=highscore;
    update(ref(db,"users/"+currentUser),{highscore});
  }
}

async function updateLeaderboard(){
  const q=query(ref(db,"users/"),orderByChild("highscore"),limitToLast(10));
  const snap=await get(q); let arr=[];
  snap.forEach(c=>arr.push(c.val()));
  arr.sort((a,b)=>b.highscore-b.highscore);
  leaderboardEl.innerHTML=arr.map(u=>(u.username===currentUsername?`<b>${u.username}: ${u.highscore}</b>`:`${u.username}: ${u.highscore}`)).join("<br>");
}
setInterval(updateLeaderboard,3000);

// --- Input ---
window.addEventListener('keydown',e=>{if(e.code==="Space") wantJump=true; if(e.key==="r"&&gameOver) resetGame();});
window.addEventListener('keyup',e=>{if(e.code==="Space") wantJump=false;});
canvas.addEventListener('mousedown',()=>{wantJump=true; setTimeout(()=>wantJump=false,100);});
canvas.addEventListener('touchstart',e=>{e.preventDefault(); wantJump=true; setTimeout(()=>wantJump=false,150);},{passive:false});

// --- Game Loop ---
function update(){
  if(gameOver) return;
  frame++; baseSpeed+=frame%300===0?0.3:0; speed=baseSpeed+Math.floor(frame/600)*0.4;
  if(wantJump && player.grounded){player.vy=player.jumpPower;player.grounded=false;}
  player.vy+=0.7; player.y+=player.vy;
  if(player.y+player.h>=ground.y){player.y=ground.y-player.h;player.vy=0;player.grounded=true;}
  spawnTimer++; if(spawnTimer>=spawnInterval){spawnObstacle(); spawnTimer=0; spawnInterval=Math.max(50,Math.round(60+Math.random()*80-frame*0.02));}
  for(let i=obstacles.length-1;i>=0;i--){
    const ob=obstacles[i]; ob.x-=speed;
    if(!ob.passed&&ob.x+ob.w<player.x){ob.passed=true; score+=10;}
    if(ob.x+ob.w<-50) obstacles.splice(i,1);
    if(collides(player,ob)){gameOver=true; saveHighscore(); if(currentMode==="story"){level++; if(level<storyTexts.length) storyPanel.style.display="flex";}}
  }
  score+=0.02*speed; scoreEl.textContent=Math.floor(score);
}

function draw(){
  ctx.clearRect(0,0,Wc,Hc);
  ctx.fillStyle="#4CAF50"; ctx.fillRect(0,ground.y,Wc,ground.h);
  for(const ob of obstacles){ctx.fillStyle=ob.color; ctx.fillRect(ob.x,ob.y,ob.w,ob.h);}
  ctx.fillStyle=player.color; ctx.fillRect(player.x,player.y,player.w,player.h);
  if(gameOver){ctx.fillStyle="rgba(0,0,0,0.6)";ctx.fillRect(0,0,Wc,Hc); ctx.fillStyle="white"; ctx.font="bold 36px system-ui"; ctx.textAlign="center"; ctx.fillText("Game Over",Wc/2,Hc/2-10);}
}

function loop(){update(); draw(); requestAnimationFrame(loop);}
function startGame(mode){currentMode=mode; resetGame(); if(mode==="story"){storyPanel.style.display="flex";} loop();}
</script>
</body>
</html>












