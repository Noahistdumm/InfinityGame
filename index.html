<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Unendliches Jump & Run</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div id="authSection">
    <h2>Login / Registrierung</h2>
    <input id="email" placeholder="E-Mail"><br>
    <input id="password" type="password" placeholder="Passwort"><br>
    <input id="username" placeholder="Benutzername (nur bei Registrierung)"><br>
    <button id="registerBtn">Registrieren</button>
    <button id="loginBtn">Login</button>
    <div id="authMessage" style="color:red; font-weight:bold; margin-top:10px;"></div>
  </div>

  <div id="gameWrap" style="display:none;">
    <canvas id="game" width="900" height="420"></canvas>
    <div class="hud">
      <div class="panel">Score: <span id="score">0</span></div>
      <div class="panel">Highscore: <span id="highscore">0</span></div>
      <div class="panel" id="leaderboard">Highscores werden geladen...</div>
      <div class="controls">Tasten: Leertaste / Klick / Tippen zum Springen</div>
      <button id="pauseBtn">Pause</button>
      <button id="resetBtn">Neustart</button>
    </div>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import {
  getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword,
  onAuthStateChanged, setPersistence, browserLocalPersistence
} from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
import {
  getDatabase, ref, set, get, onValue, runTransaction
} from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";

// --- Firebase-Konfiguration ---
const firebaseConfig = {
  apiKey: "AIzaSyA_IPMf3X1PABrfMlrpgT0tMCTeQVnhLUs",
  authDomain: "jumpandrunhighscore.firebaseapp.com",
  databaseURL: "https://jumpandrunhighscore-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "jumpandrunhighscore",
  storageBucket: "jumpandrunhighscore.firebasestorage.app",
  messagingSenderId: "770421489723",
  appId: "1:770421489723:web:8bc433474dae3d7d5edc1e",
  measurementId: "G-SJD78YNJK0"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

let currentUser = null;
let currentUsername = "";

// UI-Elemente
const msg = document.getElementById("authMessage");
const gameWrap = document.getElementById("gameWrap");
const authSection = document.getElementById("authSection");

// --- Leaderboard ---
function setupLeaderboardRealtime() {
  const usersRef = ref(db, "users");
  onValue(usersRef, snapshot => {
    if (!snapshot.exists()) {
      document.getElementById("leaderboard").innerText = "Keine Highscores vorhanden";
      return;
    }
    const data = snapshot.val();
    const arr = Object.values(data).map(u => ({ username: u.username, highscore: u.highscore || 0 }));
    arr.sort((a, b) => b.highscore - a.highscore);
    const top10 = arr.slice(0, 10);
    document.getElementById("leaderboard").innerHTML = top10.map(u =>
      u.username === currentUsername ? `<b>${u.username}: ${u.highscore}</b>` : `${u.username}: ${u.highscore}`
    ).join("<br>");
  });
}

// --- Registrierung ---
async function registerUser() {
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value;
  const username = document.getElementById("username").value.trim();
  if (!username || !email || !password) { msg.style.color="red"; msg.textContent="E-Mail, Passwort & Benutzername erforderlich"; return; }
  await setPersistence(auth, browserLocalPersistence);
  try {
    const userCred = await createUserWithEmailAndPassword(auth, email, password);
    await set(ref(db,"users/"+userCred.user.uid),{username,highscore:0});
    msg.style.color="green"; msg.textContent="Registriert & automatisch eingeloggt";
  } catch(e) { msg.style.color="red"; msg.textContent=e.message; }
}

// --- Login ---
async function loginUser() {
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value;
  if (!email || !password) { msg.style.color="red"; msg.textContent="E-Mail & Passwort erforderlich"; return; }
  await setPersistence(auth, browserLocalPersistence);
  try { await signInWithEmailAndPassword(auth,email,password); msg.style.color="green"; msg.textContent="Login erfolgreich"; }
  catch(e) { msg.style.color="red"; msg.textContent=e.message; }
}

document.getElementById("registerBtn").addEventListener("click", registerUser);
document.getElementById("loginBtn").addEventListener("click", loginUser);

// --- onAuthStateChanged ---
onAuthStateChanged(auth, async user=>{
  if(!user) return;
  currentUser=user.uid;
  try {
    const snap = await get(ref(db,"users/"+currentUser));
    let dbHighscore = 0;
    if(snap.exists()){ const data = snap.val(); currentUsername = data.username; dbHighscore = data.highscore || 0; }
    else{ await set(ref(db,"users/"+currentUser),{username:"Spieler",highscore:0}); }
    setupLeaderboardRealtime();
    msg.style.color="green"; msg.textContent="Willkommen zur√ºck, "+currentUsername;
    startGame(dbHighscore);
  } catch(e){ console.error(e); startGame(0); }
});

// --- Spiel ---
let gameRunning = false;
function startGame(existingHighscore = 0){
  if(gameRunning) return;
  gameRunning = true;

  authSection.style.display = "none";
  gameWrap.style.display = "flex";

  const canvas = document.getElementById("game");
  const ctx = canvas.getContext("2d");
  const W = canvas.width, H = canvas.height;
  const scoreEl = document.getElementById("score");
  const highscoreEl = document.getElementById("highscore");

  let score = 0;
  let highscore = existingHighscore;
  let lastSaved = highscore;
  highscoreEl.textContent = highscore;

  const player = { x:120, y:H-140, w:44, h:60, vy:0, jumpPower:-13, grounded:true, color:"#ff6b6b", anim:0 };
  const ground = { y:H-80, height:80 };
  let obstacles = [], clouds = [];
  let spawnTimer=0, speed=5, frame=0, gameOver=false, paused=false, wantJump=false;

  async function saveHighscoreIfHigher(s){
    if(!currentUser || s<=lastSaved) return;
    try{ await runTransaction(ref(db,"users/"+currentUser+"/highscore"),old=>old===null||s>old?s:old); lastSaved=s; }
    catch(e){ console.warn("Highscore Transaction fehlgeschlagen",e); }
  }

  function saveHighscoreLocal(){ const s=Math.floor(score); if(s>highscore){ highscore=s; highscoreEl.textContent=highscore; saveHighscoreIfHigher(s); } }

  function rand(a,b){ return Math.random()*(b-a)+a; }
  function spawnObstacle(){ const h=rand(20,50), w=rand(18,36), y=ground.y-h; obstacles.push({x:W+20,y,w,h,color:"#2d3436",passed:false}); }
  function spawnCloud(){ const y=rand(30,150), w=rand(60,120); clouds.push({x:W+50,y,w,h:30,speed:rand(0.7,2)}); }

  function collides(a,b){ const buf=8; return a.x+buf<b.x+b.w && a.x+a.w-buf>b.x && a.y+buf<b.y+b.h && a.y+a.h-buf>b.y; }

  function resetGame(){ saveHighscoreLocal(); obstacles=[]; clouds=[]; spawnTimer=0; speed=5; score=0; frame=0; gameOver=false; player.y=ground.y-player.h; player.vy=0; player.grounded=true; scoreEl.textContent=0; }

  // Controls
  window.addEventListener("keydown", e=>{ if(e.code==="Space") wantJump=true; if(e.key==="r"&&gameOver) resetGame(); });
  window.addEventListener("keyup", e=>{ if(e.code==="Space") wantJump=false; });
  canvas.addEventListener("mousedown",()=>{ wantJump=true; setTimeout(()=>wantJump=false,120); });
  canvas.addEventListener("touchstart",e=>{ e.preventDefault(); wantJump=true; setTimeout(()=>wantJump=false,150); },{passive:false});
  document.getElementById("pauseBtn").addEventListener("click",()=>paused=!paused);
  document.getElementById("resetBtn").addEventListener("click",resetGame);

  function update(){
    if(paused||gameOver) return;
    frame++; if(frame%300===0)speed+=0.3;
    if(wantJump && player.grounded){ player.vy=player.jumpPower; player.grounded=false; }
    player.vy+=0.7; player.y+=player.vy; player.anim+=0.2;
    if(player.y+player.h>=ground.y){ player.y=ground.y-player.h; player.vy=0; player.grounded=true; }
    spawnTimer++; if(spawnTimer>=90){ spawnObstacle(); spawnTimer=0; }
    if(frame%200===0) spawnCloud();

    clouds.forEach(c=>c.x-=c.speed); clouds=clouds.filter(c=>c.x+c.w>-50);
    obstacles.forEach(o=>{ o.x-=speed; if(!o.passed && o.x+o.w<player.x){ o.passed=true; score+=10; } });
    obstacles=obstacles.filter(o=>o.x+o.w>-50);
    obstacles.forEach(o=>{ if(collides(player,o)){ gameOver=true; saveHighscoreLocal(); } });
    score+=0.02*speed; scoreEl.textContent=Math.floor(score);
    saveHighscoreLocal();
  }

  function draw(){
    ctx.clearRect(0,0,W,H);
    ctx.fillStyle="#87CEEB"; ctx.fillRect(0,0,W,H);
    ctx.fillStyle="white"; clouds.forEach(c=>ctx.fillRect(c.x,c.y,c.w,c.h));
    ctx.fillStyle="#4CAF50"; ctx.fillRect(0,ground.y,W,ground.height);
    ctx.fillStyle=player.color; ctx.fillRect(player.x,player.y+Math.sin(player.anim)*2,player.w,player.h);
    obstacles.forEach(o=>{ ctx.fillStyle=o.color; ctx.fillRect(o.x,o.y,o.w,o.h); });
    if(gameOver){ ctx.fillStyle="rgba(0,0,0,0.6)"; ctx.fillRect(0,0,W,H); ctx.fillStyle="white"; ctx.font="bold 36px system-ui"; ctx.textAlign="center"; ctx.fillText("Game Over",W/2,H/2); }
  }

  function loop(){ update(); draw(); requestAnimationFrame(loop); }
  loop();
  window.addEventListener("beforeunload", saveHighscoreLocal);
}
</script>
</body>
</html>

