<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Jump & Run Game</title>
  <style>
    body { margin:0; font-family: Arial, sans-serif; background:#87CEEB; }
    #authSection { text-align:center; margin-top:40px; }
    #authSection input { margin:5px; padding:8px; border-radius:6px; border:1px solid #ccc; width:220px; }
    button { margin:6px; padding:8px 12px; border:none; border-radius:6px; background:#1f8ef1; color:white; font-weight:bold; cursor:pointer; }
    #logoutBtn { background:#e74c3c; }
    #gameWrap { display:none; flex-direction:column; align-items:center; margin-top:20px; }
    canvas { background:linear-gradient(#87CEEB,#6FC3F0); border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,0.2); }
    .hud { margin-top:12px; display:flex; gap:12px; flex-wrap:wrap; justify-content:center; }
    .panel { background:rgba(255,255,255,0.9); padding:6px 12px; border-radius:8px; font-weight:bold; }
  </style>
</head>
<body>
  <!-- LOGIN -->
  <div id="authSection">
    <h2>Login / Registrierung</h2>
    <input id="email" placeholder="E-Mail"><br>
    <input id="password" type="password" placeholder="Passwort"><br>
    <input id="username" placeholder="Benutzername (nur bei Registrierung)"><br>
    <button id="registerBtn">Registrieren</button>
    <button id="loginBtn">Login</button>
    <button id="logoutBtn" style="display:none;">Abmelden</button>
    <div id="authMessage" style="color:red; font-weight:bold; margin-top:10px;"></div>
  </div>

  <!-- GAME -->
  <div id="gameWrap">
    <canvas id="gameCanvas" width="900" height="420"></canvas>
    <div class="hud">
      <div class="panel">Score: <span id="score">0</span></div>
      <div class="panel">Highscore: <span id="highscore">0</span></div>
      <div class="panel" id="leaderboard">Highscores werden geladen...</div>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut }
    from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
  import { getDatabase, ref, set, get, update, query, orderByChild, limitToLast }
    from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";

  // --- Firebase Config ---
  const firebaseConfig = {
    apiKey: "AIzaSyA_IPMf3X1PABrfMlrpgT0tMCTeQVnhLUs",
    authDomain: "jumpandrunhighscore.firebaseapp.com",
    databaseURL: "https://jumpandrunhighscore-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "jumpandrunhighscore",
    storageBucket: "jumpandrunhighscore.appspot.com",
    messagingSenderId: "770421489723",
    appId: "1:770421489723:web:8bc433474dae3d7d5edc1e",
    measurementId: "G-SJD78YNJK0"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  let currentUser = null;
  let currentUsername = "";
  let highscore = 0;

  const msg = document.getElementById("authMessage");
  const gameWrap = document.getElementById("gameWrap");
  const authSection = document.getElementById("authSection");
  const logoutBtn = document.getElementById("logoutBtn");

  // Registrierung
  async function registerUser() {
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;
    const username = document.getElementById("username").value;
    if(!username){ msg.textContent="Bitte Benutzernamen eingeben"; return; }
    try {
      const userCredential = await createUserWithEmailAndPassword(auth, email, password);
      await set(ref(db, "users/" + userCredential.user.uid), { username, highscore: 0 });
      msg.style.color="green"; msg.textContent="Registrierung erfolgreich!";
    } catch(err) { msg.style.color="red"; msg.textContent=err.message; }
  }

  // Login
  async function loginUser() {
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;
    try {
      await signInWithEmailAndPassword(auth, email, password);
    } catch(err) { msg.style.color="red"; msg.textContent=err.message; }
  }

  // Abmelden
  logoutBtn.addEventListener("click", ()=> signOut(auth));

  // Auth Status beobachten (eingeloggt bleiben)
  onAuthStateChanged(auth, async (user)=>{
    if(user){
      currentUser=user.uid;
      const snap=await get(ref(db,"users/"+currentUser));
      if(snap.exists()){ 
        currentUsername=snap.val().username;
        highscore=snap.val().highscore||0;
      }
      authSection.style.display="none";
      logoutBtn.style.display="inline-block";
      gameWrap.style.display="flex";
      msg.textContent="";
      startGame();
    } else {
      currentUser=null;
      currentUsername="";
      authSection.style.display="block";
      gameWrap.style.display="none";
      logoutBtn.style.display="none";
    }
  });

  // Buttons verbinden
  document.getElementById("registerBtn").addEventListener("click", registerUser);
  document.getElementById("loginBtn").addEventListener("click", loginUser);

  // --- GAME LOGIK ---
  function startGame(){
    const canvas=document.getElementById("gameCanvas");
    const ctx=canvas.getContext("2d");
    let W=canvas.width, H=canvas.height;
    let score=0;
    let obstacles=[], frame=0;
    const player={x:120,y:0,w:44,h:60,vy:0,color:"#ff6b6b",grounded:false};
    const ground={y:H-80,height:80};
    let gameOver=false;
    const scoreEl=document.getElementById("score");
    const highscoreEl=document.getElementById("highscore");
    highscoreEl.textContent=highscore;

    function resetPlayer(){ player.y=ground.y-player.h; player.vy=0; player.grounded=true; }
    resetPlayer();

    function collides(a,b){ return a.x<a.w+b.x && a.x+a.w>b.x && a.y<a.h+b.y && a.y+a.h>b.y; }
    function spawnObstacle(){ obstacles.push({x:W+20,y:ground.y-40,w:30,h:40}); }
    function saveHighscore(){ if(score>highscore){ highscore=score; update(ref(db,"users/"+currentUser),{highscore}); highscoreEl.textContent=highscore; } }

    async function updateLeaderboard(){
      const q=query(ref(db,"users"), orderByChild("highscore"), limitToLast(5));
      const snap=await get(q);
      const arr=[]; snap.forEach(c=>arr.push(c.val()));
      arr.sort((a,b)=>b.highscore-a.highscore);
      document.getElementById("leaderboard").innerHTML=arr.map(u=>u.username+": "+u.highscore).join("<br>");
    }
    setInterval(updateLeaderboard,3000);

    window.addEventListener("keydown",e=>{
      if(e.code==="Space"&&player.grounded){ player.vy=-13; player.grounded=false; }
    });

    function loop(){
      if(!gameOver){
        frame++; score++;
        ctx.clearRect(0,0,W,H);
        ctx.fillStyle="#4CAF50"; ctx.fillRect(0,ground.y,W,ground.height);

        // Spieler
        player.vy+=0.7; player.y+=player.vy;
        if(player.y+player.h>=ground.y){ resetPlayer(); }
        ctx.fillStyle=player.color; ctx.fillRect(player.x,player.y,player.w,player.h);

        // Hindernisse
        if(frame%100===0) spawnObstacle();
        for(let i=obstacles.length-1;i>=0;i--){
          let ob=obstacles[i]; ob.x-=5;
          ctx.fillStyle="#2d3436"; ctx.fillRect(ob.x,ob.y,ob.w,ob.h);
          if(collides(player,ob)){ gameOver=true; saveHighscore(); }
          if(ob.x+ob.w<0) obstacles.splice(i,1);
        }

        scoreEl.textContent=score;
      }
      requestAnimationFrame(loop);
    }
    loop();
  }
</script>
</body>
</html>
